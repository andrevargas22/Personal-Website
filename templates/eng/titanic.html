<!doctype html>
<html lang="en">

<head>
    <!-- Header File -->
    {% include 'common/header.html' %}
    <!-- Page CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/titanic.css') }}">
    <style>
        .custom-header {
            text-align: left;
            font-size: smaller;
        }
        .button-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-text {
            margin-left: 10px;
        }
        .bold-text {
            font-weight: bold;
        }
    </style>
</head>

<body>
    
    <!-- Navigation Bar -->
    {% include 'common/navbar.html' %}
    
    <!-- Required CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <div class="container">
        <!-- Page Header -->
        <div class="row">
            <div class="col-lg-12 text-center my-2">
                <h4 class="border-bottom border-dark p-2">Titanic API</h4>
                <center>
                    <p>
                        Projeto de API para o dataset Titanic, Desafio Grupo Casas Bahia.
                    </p>
                </center>
            </div>
        </div>

        <p class="header">
            Essa página consome uma API de um modelo que prevê a sobrevivência de passageiros do Titanic. 
        
            Este modelo foi treinado no conjunto de dados do Titanic utilizando RandomForest, e está armazenado em um Model Registry no servidor MLFlow. 
            Ao clicar em "Predict", os dados são enviados para um endpoint FastAPI implantado com Docker no Google Cloud Run. Esta API busca o modelo no Model Registry do MLFlow, 
            processa os dados e retorna as previsões de sobrevivência.
            <br><br>
            <strong>Instruções:</strong> 
            <ul>
                <li>Prepare um arquivo CSV contendo os dados dos passageiros. O CSV deve incluir as seguintes colunas: <code>Pclass</code> (numérico), <code>Sex</code> (string), <code>SibSp</code> (numérico), <code>Parch</code> (numérico) e <code>Fare</code> (numérico). Certifique-se de que os tipos de dados estão corretos.</li>
                <li>Carregue o CSV na página com os botões "Choose File" e "Carregar" para visualizar as primeiras 5 linhas na tabela abaixo.</li>
                <li>Verifique se os dados estão corretos. Se estiverem, clique no botão "Predict" que será exibido após carregar o CSV.</li>
                <li>A API processará os dados e retornará as previsões na última coluna da tabela. As previsões indicarão "Survived" e "Not survived".</li>
                <li>Se desejar baixar o arquivo com os resultados completos, clique no botão "Baixar resultados".</li>
            </ul>
        </p>

        <div class="row">
            <div class="col-lg-12 text-center my-2">
                <input type="file" id="csvFileInput" accept=".csv" class="form-control-file">
                <button class="btn btn-primary my-2" onclick="loadCSV()">Carregar</button>
                <button class="btn btn-info my-2" onclick="viewMetadata()">Ver Metadados</button>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 text-center my-2">
                <h5 class="border-bottom border-dark p-2 custom-header" id="data-title" style="display: none;">Primeiras linhas:</h5>
                <table id="csvTable" class="table table-striped">
                    <thead>
                        <tr id="csvTableHeader"></tr>
                    </thead>
                    <tbody id="csvTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="row" id="predict-section" style="display: none;">
            <div class="col-lg-12 text-center my-2 button-container">
                <button class="btn btn-success" onclick="predict()">Predict</button>
                <span id="loading-text" class="loading-text" style="display: none;">Aguardando Resultados...</span>
            </div>
        </div>

        <div class="row" id="download-section" style="display: none;">
            <div class="col-lg-12 text-center my-2">
                <button class="btn btn-warning" onclick="downloadResults()">Baixar resultados</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    
    <script>
        let csvData = [];
        let fullData = [];
    
        function loadCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        fullData = results.data;
                        csvData = results.data.slice(0, 5); // Only keep the first 5 rows for display
                        const headers = Object.keys(csvData[0]);
    
                        // Clear previous table data
                        document.getElementById('csvTableHeader').innerHTML = '';
                        document.getElementById('csvTableBody').innerHTML = '';
    
                        // Append headers to table
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.innerText = header.trim();
                            document.getElementById('csvTableHeader').appendChild(th);
                        });
    
                        // Append rows to table
                        csvData.forEach(row => {
                            const tr = document.createElement('tr');
                            headers.forEach(header => {
                                const td = document.createElement('td');
                                td.innerText = row[header];
                                tr.appendChild(td);
                            });
                            document.getElementById('csvTableBody').appendChild(tr);
                        });
    
                        // Show the predict button and title
                        document.getElementById('predict-section').style.display = 'block';
                        document.getElementById('data-title').style.display = 'block';
                    }
                });
            }
        }
    
        function predict() {
            document.getElementById('loading-text').style.display = 'inline'; // Show loading text
            fetch('https://titanic-api-wno7iop4fa-uc.a.run.app/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(fullData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-text').style.display = 'none'; // Hide loading text
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    const headers = Object.keys(csvData[0]);
                    
                    // Append prediction header if not already present
                    if (!document.getElementById('csvTableHeader').innerHTML.includes('Prediction')) {
                        const th = document.createElement('th');
                        th.innerText = 'Prediction';
                        document.getElementById('csvTableHeader').appendChild(th);
                    }
    
                    // Update rows with predictions
                    data.predictions.slice(0, 5).forEach((prediction, index) => {
                        const td = document.createElement('td');
                        td.innerText = prediction === 1 ? 'Survived' : 'Not survived';
                        td.classList.add('bold-text');
                        document.getElementById('csvTableBody').rows[index].appendChild(td);
                    });
    
                    // Add predictions to full data for download
                    fullData = fullData.map((row, index) => {
                        return { ...row, Prediction: data.predictions[index] === 1 ? 'Survived' : 'Not survived' };
                    });
    
                    // Show the download button
                    document.getElementById('download-section').style.display = 'block';
    
                    alert("Success: Predictions received!");
                }
            })
            .catch(error => {
                document.getElementById('loading-text').style.display = 'none'; // Hide loading text
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            });
        }
    
        function viewMetadata() {
            fetch('https://titanic-api-wno7iop4fa-uc.a.run.app/metadata')
            .then(response => response.json())
            .then(data => {
                const { tags, params, metrics } = data;

                const formattedMetadata = `
                Author: ${tags["mlflow.user"]}
                Model: ${tags["model_type"]}
                Description: ${tags["experiment_description"]}
                Run Name: ${tags["mlflow.runName"]}

                Params:
                n_estimators: ${params["n_estimators"]}
                max_depth: ${params["max_depth"]}
                min_samples_split: ${params["min_samples_split"]}
                min_samples_leaf: ${params["min_samples_leaf"]}
                max_features: ${params["max_features"]}

                Metrics:
                f1_score: ${metrics["f1_score"]}
                `;

                alert(`Metadados:\n${formattedMetadata}`);
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            });
        }
    
        function downloadResults() {
            const csv = Papa.unparse(fullData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'predictions.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
    
</body>

</html>