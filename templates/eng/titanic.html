<!doctype html>
<html lang="en">

<head>
    <!-- Header File -->
    {% include 'common/header.html' %}
    <!-- Page CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/titanic.css') }}">
    <style>
        .custom-header {
            text-align: left;
            font-size: smaller;
        }
    </style>
</head>

<body>
    
    <!-- Navigation Bar -->
    {% include 'common/navbar.html' %}
    
    <!-- Required CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <div class="container">
        <!-- Page Header -->
        <div class="row">
            <div class="col-lg-12 text-center my-2">
                <h4 class="border-bottom border-dark p-2">Titanic API</h4>
                <center>
                    <p>
                        Projeto de API para o dataset Titanic, Desafio Grupo Casas Bahia.
                    </p>
                </center>
            </div>
        </div>

        <p class="header">
            <strong>Instruções:</strong> Essa página consome uma API de um modelo que prevê a sobrevivência de passageiros do Titanic. 

            Este modelo foi treinado no conjunto de dados do Titanic utilizando RandomForest, e está armazenado em um Model Registry no servidor MLFlow. 
            Ao clicar em "Predict", os dados são enviados para um endpoint FastAPI implantado com Docker no Google Cloud Run. Esta API busca o modelo no Model Registry do MLFlow, 
            processa os dados e retorna as previsões de sobrevivência.
        </p>

        <div class="row">
            <div class="col-lg-12 text-center my-2">
                <input type="file" id="csvFileInput" accept=".csv" class="form-control-file">
                <button class="btn btn-primary my-2" onclick="loadCSV()">Carregar CSV</button>
            </div>
        </div>

        <div class="row" id="predict-section" style="display: none;">
            <div class="col-lg-12 text-center my-2">
                <button class="btn btn-success my-2" onclick="predict()">Predict</button>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 text-center my-2">
                <h5 class="border-bottom border-dark p-2 custom-header" id="data-title" style="display: none;">Primeiras 5 linhas do CSV</h5>
                <table id="csvTable" class="table table-striped">
                    <thead>
                        <tr id="csvTableHeader"></tr>
                    </thead>
                    <tbody id="csvTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="row" id="download-section" style="display: none;">
            <div class="col-lg-12 text-center my-2">
                <button class="btn btn-warning my-2" onclick="downloadResults()">Baixar resultados</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    
    <script>
        let csvData = [];
        let fullData = [];
    
        function loadCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        fullData = results.data;
                        csvData = results.data.slice(0, 5); // Only keep the first 5 rows for display
                        const headers = Object.keys(csvData[0]);
    
                        // Clear previous table data
                        document.getElementById('csvTableHeader').innerHTML = '';
                        document.getElementById('csvTableBody').innerHTML = '';
    
                        // Append headers to table
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.innerText = header.trim();
                            document.getElementById('csvTableHeader').appendChild(th);
                        });
    
                        // Append rows to table
                        csvData.forEach(row => {
                            const tr = document.createElement('tr');
                            headers.forEach(header => {
                                const td = document.createElement('td');
                                td.innerText = row[header];
                                tr.appendChild(td);
                            });
                            document.getElementById('csvTableBody').appendChild(tr);
                        });
    
                        // Show the predict button and title
                        document.getElementById('predict-section').style.display = 'block';
                        document.getElementById('data-title').style.display = 'block';
                    }
                });
            }
        }
    
        function predict() {
            fetch('http://127.0.0.1:8000/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(fullData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    const headers = Object.keys(csvData[0]);
                    
                    // Append prediction header if not already present
                    if (!document.getElementById('csvTableHeader').innerHTML.includes('Prediction')) {
                        const th = document.createElement('th');
                        th.innerText = 'Prediction';
                        document.getElementById('csvTableHeader').appendChild(th);
                    }
    
                    // Update rows with predictions
                    data.predictions.slice(0, 5).forEach((prediction, index) => {
                        const td = document.createElement('td');
                        td.innerText = prediction === 1 ? 'Survived' : 'Not survived';
                        document.getElementById('csvTableBody').rows[index].appendChild(td);
                    });
    
                    // Add predictions to full data for download
                    fullData = fullData.map((row, index) => {
                        return { ...row, Prediction: data.predictions[index] === 1 ? 'Survived' : 'Not survived' };
                    });
    
                    // Show the download button
                    document.getElementById('download-section').style.display = 'block';
    
                    alert("Success: Predictions received!");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            });
        }
    
        function downloadResults() {
            const csv = Papa.unparse(fullData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'predictions.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
    
</body>

</html>
